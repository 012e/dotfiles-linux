#!/bin/fish

set -l command $argv[1]

set -l parent_pid (tmux display-message -p '#S')
set -l parent_path (tmux display-message -p "#{pane_current_path}")

set -l popup_session       "popup"$parent_pid
tmux new-session  -d -s $popup_session &> /dev/null
set -l popup_active_window (string trim --char=: (tmux list-windows -t $popup_session | rg active | awk '{print $1}'))
set -l popup_target        "$popup_session:$popup_active_window"
set -l popup_path          (tmux display-message -t $popup_target -p "#{pane_current_path}")
if not test $popup_path = $parent_path
  tmux new-window -t "$popup_session" -c "$parent_path"
  set -l new_window_name (string trim --char=: (tmux list-windows -t $popup_session | rg --fixed-strings '*' | awk '{print $1}'))
  tmux select-window -t $popup_session:$new_window_name
  tmux send-keys -t $popup_session:$new_window_name $command Enter
else
  tmux send-keys -t $popup_target $command Enter
end
popuptmux $parent_pid $parent_path
# tmux -s $popup_session_name list-panes
